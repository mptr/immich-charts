{{- define "immich.server.hardcodedValues" -}}
global:
  nameOverride: server

{{ if .Values.immich.configuration }}
defaultPodOptions:
  annotations:
    checksum/config: {{ .Values.immich.configuration | toYaml | sha256sum }}
{{- end }}

{{- $result := dict -}}

{{- if .Values.server.enabled -}}
  {{- $server := include "immich.server.combined" (dict "root" . "name" "main") | fromYaml -}}
  {{- $result = mustMergeOverwrite $result $server -}}
{{- end -}}

{{- if .Values.api.enabled -}}
  {{- $api := include "immich.server.api" (dict "root" . "name" "api") | fromYaml -}}
  {{- $result = mustMergeOverwrite $result $api -}}
{{- end -}}

{{- if .Values.microservices.enabled -}}
  {{- $ms := include "immich.server.microservices" (dict "root" . "name" "microservices") | fromYaml -}}
  {{- $result = mustMergeOverwrite $result $ms -}}
{{- end -}}

{{- $result | toYaml }}

persistence:
{{- if .Values.immich.configuration }}
  config:
    enabled: true
    {{- if eq .Values.immich.configurationKind "Secret" }}
    type: secret
    {{- else }}
    type: configMap
    {{- end }}
    name: {{ .Release.Name }}-immich-config
{{- end }}
  data:
    enabled: true
    existingClaim: {{ .Values.immich.persistence.library.existingClaim }}
{{- end }}

{{ if .Values.server.enabled }}
{{- $ctx := deepCopy . -}}
{{- $_ := get .Values "server" | mergeOverwrite $ctx.Values -}}
{{- $_ = include "immich.server.hardcodedValues" . | fromYaml | merge $ctx.Values -}}
{{- include "bjw-s.common.loader.all" $ctx }}
{{ end }}
